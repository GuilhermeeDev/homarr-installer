# Docker Compose para HomeServer - Configurações otimizadas e atualizadas
# Feito por: Guilherme Souza

# -- SERVIÇOS INCLUÍDOS:
# - Homarr
# - Portainer
# - Uptime Kuma
# - Nginx Proxy Manager 
# - FileBrowser

# -- CONFIGURAÇÕES PADRONIZADAS:
# - Rede virtual: homeserver (bridge)
# - Logging: json-file com rotação de logs (max-size: 50MB, max-file: 5)
# - Restart: unless-stopped para todos os serviços
# - Limites de memória e CPU configurados para cada serviço

networks:
  homeserver:
    name: homeserver
    driver: bridge

x-defaults: &defaults
  restart: unless-stopped

  networks:
    - homeserver      

  logging:
    driver: "json-file"
    options:
      max-size: "50MB"
      max-file: "5"

# ---- SERVIÇOS ---- #
services:
# HOMARR
  homarr:
    <<: *defaults
    image: ghcr.io/homarr-labs/homarr:latest
    container_name: homarr

    ports:
      - "${HOMARR_PORT}:7575"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/homarr:/appdata

    environment:
      - TZ=${TZ}
      - SECRET_ENCRYPTION_KEY=${HOMARR_SECRET_KEY}

    mem_limit: 512MB
    cpus: '1.0'

# PORTAINER
  portainer:
    <<: *defaults
    image: portainer/portainer-ce:2.38.1-linux-amd64-alpine
    container_name: portainer
    
    ports:
      - "${PORTAINER_PORT}:9000"

    environment:
      - TZ=${TZ}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/portainer:/data
    
    mem_limit: 512MB
    cpus: '1.0'

# UPTIME-KUMA
  uptime-kuma:
    <<: *defaults
    image: louislam/uptime-kuma:2-slim
    container_name: uptime-kuma

    ports:
      - "${UPTIME-KUMA_PORT}:3001"

    environment:
      - TZ=${TZ}

    volumes:
      - ./data/uptime-kuma:/app/data
    
    mem_limit: 256MB
    cpus: '1.0'

# NGINX PROXY MANAGER
  nginx-proxy:
    <<: *defaults
    image: jc21/nginx-proxy-manager:2
    container_name: nginx-proxy
    
    ports:
      - "${NGINX_PROXY_MANAGER_PORT1}:80"
      - "${NGINX_PROXY_MANAGER_PORT2}:81"
      - "${NGINX_PROXY_MANAGER_PORT3}:443"

    environment:
      - TZ=${TZ}

    volumes:
      - ./data/nginx-proxy-manager:/data
      - ./data/letsencrypt:/etc/letsencrypt
    
    mem_limit: 512MB
    cpus: '1.0'

# FILEBROWSER
  filebrowser:
    <<: *defaults
    image: filebrowser/filebrowser:v2-amd64-s6
    container_name: filebrowser
    
    ports:
      - ${FILEBROWSER_PORT}:1200

    environment:
      PUID: ${FILEBROWSER_PUID}
      PGID: ${FILEBROWSER_PGID}
    
    volumes:
      - /home/${FILEBROWSER_USER}:/srv
      - ./data/filebrowser/database:/database
      - ./data/filebrowser/config:/config